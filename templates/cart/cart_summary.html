{% extends 'base.html' %}
{% block content %}
{% load humanize %}

<div class="cartBasket container py-5">
	<h1 class="mb-5">سبد خرید</h1>
	<div class="row">
		<div class="col-lg-8">
			<!-- Cart Items -->

			<div class="card mb-4">
				<div class="card-body card-products-list">
					{% if cart_products %}

					{% for product in cart_products %}
					<div class="row cart-item mb-3" data-product-id="{{product.id}}">
						<div class="col-md-2">
							<a href="{% url 'product' product.id %}"><img src="{{ product.product_image.url }}"
									alt="Product 1" class="img-fluid" /></a>
						</div>
						<div class="col-md-5">
							<a href="{% url 'product' product.id %}">
								<h5 class="card-title">{{ product.product_name }}</h5>
							</a>
						</div>
						<div class="col-md-2">
							{% for key, value in qty.items %}
							{% if key == product.id|slugify %}
							<div class="input-group">
								<button class="btn btn-outline-secondary btn-sm minus-btn" type="button"
									data-product-id="{{ key }}">-</button>
								<input style="max-width:100px" type="text"
									class="form-control form-control-sm text-center quantity-input"
									value="{{ value.qty }}" min="1" data-product-id="{{ key }}">
								<button class="btn btn-outline-secondary btn-sm plus-btn" type="button"
									data-product-id="{{ key }}">+</button>
							</div>

							{% endif %}
							{% endfor %}
						</div>
						<div class="col-md-2 text-end">
							<p class="fw-bold">
								{% if product.is_sale %}
								{{product.sale_price | intcomma}} تومان
								{% else %}
								{{ product.product_price|intcomma }}
								{% endif %}
							</p>
						</div>
						<div class="col-md-1 text-end">
							<button class="btn btn-sm btn-outline-danger remove-item"
								data-product-id="{{ product.id }}"><i class="bi bi-trash"></i></button>
						</div>
					</div>
					{% endfor %}
					{% else %}
					<div class="row cart-item emptyCart mb-3">
						<div class="container col-md-12 text-center">
							<img src="../../static/img/empty-cart.svg" />
							<h4>سبد خرید شما خالی است!</h4>
						</div>
					</div>
					{% endif %}
				</div>
			</div>
			<div class="card mt-3">
				<div class="card-header p-3">کد تخفیف</div>
				<div class="card-body">
					<div class="card-body card-products-list">

						<div class="input-group mb-3">
							<input type="text" class="form-control" placeholder="کد تخفیف را وارد کنید" />
							<button class="btn btn-outline-secondary" type="button">ثبت کد تخفیف</button>
						</div>
					</div>
				</div>
			</div>
		</div>
		<div class="col-lg-4">
			<!-- Cart Summary -->
			<div class="card cart-summary">
				<div class="card-body p-4">
					<div class="d-flex justify-content-between mb-3">
						<span>جمع فاکتور</span>
						<span id="total_price">{{ total|floatformat:0|intcomma }} تومان</span>
					</div>
					<div class="d-flex justify-content-between mb-3">
						<span>هزینه ارسال</span>
						<span>0</span>
					</div>
					<div class="d-flex justify-content-between mb-3">
						<span>مالیات</span>
						<span>0</span>
					</div>
					<hr />
					<div class="d-flex justify-content-between" data-product-id="{{ product.id }}">
						<strong>جمع کل</strong>
						<strong id="cart_total">{{ total|floatformat:0|intcomma }} تومان</strong>
					</div>
				</div>
			</div>
			<a href="{% url 'checkout' %}" role="button">
				<button class=" btn btn-primary w-100 mt-3">تکمیل خرید</button>
			</a>

		</div>
	</div>
</div>
<script>
	function formatNumber(number) {
		return number.toString()
			.replace(/\D/g, "")
			.replace(/\B(?=(\d{3})+(?!\d))/g, ",");
	}
	$(document).ready(function () {
		// افزایش تعداد
		$(document).on('click', '.plus-btn', function () {
			const productId = $(this).data('product-id');
			const input = $(this).siblings('.quantity-input');
			let newValue = parseInt(input.val()) + 1;
			input.val(newValue);
			updateCart(productId, newValue);

		});

		// کاهش تعداد
		$(document).on('click', '.minus-btn', function () {
			const productId = $(this).data('product-id');
			const $input = $(this).siblings('.quantity-input');
			let newValue = parseInt($input.val()) - 1;

			if (newValue < 1) {
				// نمایش مودال تأیید حذف
				if (confirm('آیا مایل به حذف این کالا از سبد خرید هستید؟')) {
					removeItem(productId); // فراخوانی تابع حذف
				} else {
					$input.val(1); // بازگرداندن مقدار به 1
				}
			} else {
				$input.val(newValue);
				updateCart(productId, newValue);
			}
		});

		// تغییر دستی مقدار
		$(document).on('change', '.quantity-input', function () {
			const productId = $(this).data('product-id');
			let newValue = parseInt($(this).val());

			if (newValue < 1) {
				newValue = 1;
				$(this).val(1);
			}

			updateCart(productId, newValue);
		});
		$(document).on('click', '.remove-item', function () {
			if (confirm('آیا از حذف این کالا اطمینان دارید؟')) {
				removeItem($(this).data('product-id'));
			}
		});
	});
	// تابع آپدیت سبد خرید
	function updateCart(productId, quantity) {
		$.ajax({
			url: '{% url "cart_update" %}',
			type: 'POST',
			data: {
				product_id: productId,
				quantity: quantity,
				csrfmiddlewaretoken: '{{ csrf_token }}'
			},
			dataType: 'json',
			success: function (response) {
				// به‌روزرسانی تمام مقادیر بدون نیاز به رفرش
				$('#total_price').text(formatNumber(response.total_price) + ' تومان');
				$('#cart_total').text(formatNumber(response.total_price) + ' تومان');
				$('#cart_quantity').text(response.cart_count);
				if (response.cart_count === 0) {
					const emptyCartHTML = `
						<div class="row cart-item emptyCart mb-3">
							<div class="container col-md-12 text-center">
								<img src="/static/img/empty-cart.svg" />
								<h4>سبد خرید شما خالی است!</h4>
							</div>
						</div>`;

					$('.card-products-list').html(emptyCartHTML);
				}

				showToast('تعداد محصول بروزرسانی شد', 'success');
			},
			error: function (xhr) {
				alert("خطا در به‌روزرسانی سبد خرید");
			}
		});
	}
	// تابع حذف آیتم
	function removeItem(productId) {
		$.ajax({
			url: '{% url "cart_delete" %}',
			type: 'POST',
			data: {
				product_id: productId,
				csrfmiddlewaretoken: '{{ csrf_token }}'
			},
			dataType: 'json',
			success: function (response) {
				// حذف ردیف از جدول
				$(`[data-product-id="${productId}"]`).remove();
				// به‌روزرسانی جمع کل
				$('#cart_total').text(formatNumber(response.total_price));
				$('#total_price').text(formatNumber(response.total_price));
				$('#cart_quantity').text(response.cart_count);
				showToast('محصول از سبد خرید حذف شد', 'redToast');
				if (response.cart_count === 0) {
					const emptyCartHTML = `
						<div class="row cart-item emptyCart mb-3">
							<div class="container col-md-12 text-center">
								<img src="/static/img/empty-cart.svg" />
								<h4>سبد خرید شما خالی است!</h4>
							</div>
						</div>`;

					$('.card-products-list').prepend(emptyCartHTML);
				}
			},
			error: function (xhr) {
				showToast('خطا در حذف محصول', 'error');
			}
		});
	}
</script>
{% endblock %}